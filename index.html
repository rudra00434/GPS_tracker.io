<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime GPS Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<style>
body, html {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
}
#map {
    height: 100vh;
    width: 100vw;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
.locate-btn, .theme-btn {
    position: fixed;
    bottom: 20px;
    background: rgba(76,175,239,0.85);
    color: white;
    border: none;
    padding: 14px 18px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    transition: all 0.3s ease;
    font-size: 20px;
    z-index: 1000;
    backdrop-filter: blur(4px);
}
.locate-btn:hover, .theme-btn:hover {
    background: rgba(55,149,224,0.95);
    transform: scale(1.15);
}
.locate-btn {right:20px;}
.theme-btn {right:80px;}
.info-panel {
    position: fixed; /* always visible */
    top: 80px;       /* moved lower to avoid zoom controls */
    left: 20px;
    background: rgba(255,255,255,0.9);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-size: 14px;
    line-height: 1.5;
    z-index: 1001; /* on top of map */
}
@media(max-width:600px){
    .locate-btn{right:15px; bottom:15px; padding:12px 15px; font-size:18px;}
    .theme-btn{right:70px; bottom:15px; padding:12px 15px; font-size:18px;}
    .info-panel {
        top: 70px;    /* slightly lower */
        left: 10px;
        right: 10px;  /* allow width to adjust */
    }
}
</style>
</head>
<body>
<div id="map"></div>
<button class="locate-btn" title="Track Me">üìç</button>
<button class="theme-btn" title="Toggle Theme">üåì</button>
<div class="info-panel" id="infoPanel">Click üìç to start tracking.</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialize map
let map = L.map('map').setView([14.0860746,100.608406],6);
map.touchZoom.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable(); map.dragging.enable();

// Tile layers
let light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
let dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
let currentLayer = light;
L.control.layers({"Light": light,"Dark": dark}).addTo(map);
light.addTo(map);

// Theme toggle
document.querySelector('.theme-btn').addEventListener('click', ()=>{
    map.removeLayer(currentLayer);
    currentLayer = (currentLayer===light)? dark : light;
    map.addLayer(currentLayer);
});

// Custom marker with popup
let myIcon = L.icon({
    iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize:[40,40],
    iconAnchor:[20,40],
    popupAnchor:[0,-35]
});
let marker = L.marker([14.0860746,100.608406], {icon: myIcon})
    .addTo(map)
    .bindPopup('Starting Location')
    .openPopup();

// Path
let pathCoordinates = [];
let polyline = L.polyline(pathCoordinates,{color:'red',weight:5}).addTo(map);
const MAX_POINTS = 50;

// Info panel
let infoPanel = document.getElementById('infoPanel');

// POIs
const locations = [
    {name:"Bangkok", coords:[13.7563,100.5018]},
    {name:"Chiang Mai", coords:[18.7883,98.9853]},
    {name:"Phuket", coords:[7.8804,98.3923]}
];
locations.forEach(loc=>L.marker(loc.coords,{icon:myIcon}).addTo(map).bindPopup(loc.name));

function updateDistances(lat,lng){
    return locations.map(loc=>{
        const km = (map.distance([lat,lng],loc.coords)/1000).toFixed(2);
        return `<br><b>Distance to ${loc.name}:</b> ${km} km`;
    }).join('');
}

// Real-time tracking
let watchId, isTracking=false;
let pathBounds = L.latLngBounds([]);
let lastPos = null; // for manual speed calculation

document.querySelector('.locate-btn').addEventListener('click', ()=>{
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }

    if(!isTracking){
        watchId = navigator.geolocation.watchPosition(pos=>{
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const heading = (pos.coords.heading||0).toFixed(0);

            // Manual speed calculation (km/h)
            let speed = 'N/A';
            if(lastPos){
                const distance = map.distance([lat,lng],[lastPos.lat,lastPos.lng]); // meters
                const time = (pos.timestamp - lastPos.timestamp)/1000; // seconds
                speed = time>0 ? ((distance/time)*3.6).toFixed(1) : '0.0';
            }
            lastPos = {lat,lng,timestamp: pos.timestamp};

            // Smooth marker movement
            let currentLatLng = marker.getLatLng();
            let steps = 10;
            let i = 0;
            let deltaLat = (lat - currentLatLng.lat)/steps;
            let deltaLng = (lng - currentLatLng.lng)/steps;

            let moveInterval = setInterval(()=>{
                if(i>=steps) clearInterval(moveInterval);
                else {
                    marker.setLatLng([currentLatLng.lat + deltaLat*i, currentLatLng.lng + deltaLng*i]);
                    i++;
                }
            },50);

            // Update path
            pathCoordinates.push([lat,lng]);
            if(pathCoordinates.length>MAX_POINTS) pathCoordinates.shift();
            polyline.setLatLngs(pathCoordinates);

            // Update path bounds
            pathBounds.extend([lat,lng]);

            // Auto-zoom on mobile
            if(window.innerWidth <= 600){
                map.fitBounds(pathBounds, {padding: [50,50]});
            } else {
                map.setView([lat,lng], 15);
            }

            // Update info panel
            infoPanel.innerHTML = `<b>Current Location:</b><br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}<br>Speed: ${speed} km/h<br>Heading: ${heading}¬∞`;
            infoPanel.innerHTML += updateDistances(lat,lng);

            // Geofence alert
            const bangkok = L.latLng(13.7563,100.5018);
            if(map.distance([lat,lng],bangkok)<5000)
                infoPanel.innerHTML += "<br><span style='color:red; font-weight:bold;'>‚ö† You entered the Bangkok zone!</span>";

        }, err => alert('Unable to retrieve location'), {enableHighAccuracy:true, maximumAge:0, timeout:10000});

        isTracking=true;
        document.querySelector('.locate-btn').textContent='üõë';
    }else{
        navigator.geolocation.clearWatch(watchId);
        isTracking=false;
        document.querySelector('.locate-btn').textContent='üìç';
    }
});

// Geofence circle
L.circle([13.7563,100.5018],{radius:5000,color:'red',fillOpacity:0.2}).addTo(map);
</script>
</body>
</html>
